<!Doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>CHESS</title>
        <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
        <link rel="stylesheet" href="css/style.css">
        <script src="js/jquery-3.5.1.min.js"></script>
        <script src="js/chessboard-1.0.0.min.js"></script>
        <script src="game.js"></script>
        <script src="utils.js"></script>
    </head>
    <body>
        <div id="container">
            <div id="main">
                <div id="board" style="width: 600px"></div>
                <div id="editor" style="display:none">
                    <div id="editBoard" style="width:600px"></div>
                    <button id="editSubmit">submit</button>
                    <button id="editClear">clear</button>
                    <button id="editCancel">cancel</button>
                </div>
            </div>
            <div id="side">
                <div id="message"></div>
                <div id="settings">
                    <table>
                        <tr>
                            <td>
                                <span class="buttonCheckbox">
                                    <input type="checkbox" id="randomize"  value="random"/>
                                    <label for="randomize" class="label">Randomize</label>
                                </span>
                            </td>
                        </tr>

                        <tr>
                            <td>
                                <button id="reset">Reset</button>
                                <button id="hint">Hint</button>
                                <button id="toggleEditor">Toggle Editor</button>
                            </td>
                        </tr>
                    </table>
                </div>
                <div id="history"></div>
            </div>
        </div>
        <script src="puzzle.js"></script>
        <script type="text/javascript">
            const $board = $("#board");
            const $editor = $("#editor");

            let startingPosition = {'d5': 'bQ', 'h8': 'wN'};
            const url = new URL(document.URL);
            const fen = url.searchParams.get('fen')
            if (fen) {
                console.log(fen);
                startingPosition = ChessBoard.fenToObj(fen);
            }

            const config = {
                draggable: true,
                sparePieces: true,
                dropOffBoard: "trash",
                onDragStart: function (source, piece, position, orientation) {
                    if (piece[0] === 'w') {
                        if (piece[1] === 'K' || piece[1] === 'Q' || piece[1] === 'R' || piece[1] === 'B')
                            return false;
                    }
                    return true;
                },
                position: startingPosition
            }
            const board = new ChessBoard("editBoard", config);

            $("#toggleEditor").click(()=> {
                const hidden = $board.css("display") === "none";
                console.log(hidden);
                const boardVisibility = hidden ? "block" : "none";
                const editorVisibility = hidden ? "none" : "block";
                $board.css("display", boardVisibility);
                $editor.css("display", editorVisibility);
            });

            $("#editClear").click(() => {
                board.position({'h8': 'wN'});
            });

            $("#editCancel").click(() => {
                $board.css("display", "block");
                $editor.css("display", "none");
            });

            $("#editSubmit").click(() => {
                const url = new URL(document.location);
                url.searchParams.delete('fen');
                url.searchParams.append('fen', board.fen());

                document.location = url.toString();
            }
            )
        </script>
        <script type="text/javascript">

            function message(s) {
                $("#message").html(s);
            }

            function renderHistory(history) {
                const $history = $("#history");
                let html = "<table>"
                history.forEach(x=>{
                    html += "<tr>"
                    html += "<td>"
                    if (x.path.length == x.best_path.length) {
                        html += "⭐"
                    } else if (x.path.length <= x.best_path.length+2) {
                        html += "✅"
                    }
                    html += "</td>"
                    html += "<td>"
                    html += `${x.path.length} (${x.best_path.length})`;
                    html += "</td>"
                    html += "<td>"
                    html += `${x.time/1000}s`;
                    html += "</td>"
                    html += "<td>"
                    html += x.usedHint ? 'used hint' : '';
                    html += "</td>"
                    html += "</tr>"
                });
                html += "</table>"
                $history.html(html);
            }

            function restart() {
                let startingPosition = {'d5': 'bQ', 'h8': 'wN'};
                const url = new URL(document.URL);
                const fen = url.searchParams.get('fen')
                if (fen) {
                    console.log(fen);
                    startingPosition = ChessBoard.fenToObj(fen);
                }

                const config = {
                    startingPosition: startingPosition,
                    randomize: $("#randomize").prop("checked"),
                    onTargetReached: (state, history) => {
                        console.log(state.time, state.path, state.best_path, history.length);
                        if (state.path.length == state.best_path.length) {
                            message(`⭐ Perfect!<br> ${state.time/1000} seconds`);
                        } else if (state.path.length <= state.best_path.length+2) {
                            message(`✅ Excellent!<br> ${state.time/1000} seconds`);
                        } else {
                            message(`✅ Good!<br> ${state.time/1000} seconds`);
                        }
                        renderHistory(history);
                    },
                    onComplete: (history) => {
                        console.log('COMPLETE', history);
                        const time = history.map(x=>x.time).reduce((a,b)=>a+b)/1000;

                        const minutes = Math.floor(time/60);
                        const seconds = time-60*minutes;

                        message(`${minutes}:${seconds}`);
                        renderHistory(history);
                    }
                }
                console.log(config);
                puzzle.restart(config);
            }
            function hint() {
                puzzle.hint(true);
            }
            const puzzle = new Puzzle("#board");
            $("#reset").click(restart);
            $("#hint").click(hint);

            restart();
        </script>
    </body>
</html>
